<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Teacher Entry Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --main-red: red;
  --main-darkred: darkred;
  --main-white: white;
  --main-pale: lavenderblush;
}
body {
  font-family: "Roboto", Arial, sans-serif;
  margin: 0;
  background: var(--main-white);
  color: var(--main-red);
  min-height: 100vh;
}
header {
  background: var(--main-red);
  color: var(--main-white);
  padding: 18px 0 18px 0;
  text-align: center;
  box-shadow: 0 8px 26px -12px rgba(0,0,0,0.5);
}
h1 {
  margin: 0;
  font-family: "Montserrat", Arial, sans-serif;
  font-size: 2.3rem;
  letter-spacing: 1.5px;
  font-weight: 900;
}
.container {
  max-width: 610px;
  margin: 24px auto 0;
  background: var(--main-white);
  border: 3px solid var(--main-red);
  border-radius: 0;
  box-shadow: 0 8px 24px -10px rgba(0,0,0,0.35);
  padding: 30px 26px 32px;
}
label {
  display: block;
  font-weight: 700;
  margin-top: 18px;
  margin-bottom: 7px;
  color: var(--main-red);
  font-family: "Montserrat", Arial, sans-serif;
  letter-spacing: 1px;
}
input, select, textarea {
  width: 100%;
  padding: 9.5px 9px;
  margin-top: 2.5px;
  border-radius: 6px;
  border: 2px solid var(--main-red);
  font-size: 1.06rem;
  background: var(--main-white);
  font-family: "Roboto", Arial, sans-serif;
  box-sizing: border-box;
  color: var(--main-darkred);
  transition: box-shadow 0.16s, border-color 0.2s, background 0.2s;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--main-darkred);
  outline: none;
  background: var(--main-pale);
  box-shadow: 0 0 0 2px rgba(224,0,0,0.2);
}
textarea { resize: vertical; }
button {
  margin-top: 15px;
  padding: 12px 25px;
  border: none;
  border-radius: 999px;
  cursor: pointer;
  font-size: 1.05rem;
  font-family: "Montserrat", Arial, sans-serif;
  font-weight: 700;
  letter-spacing: 1px;
  transition: background 0.22s, color 0.22s, box-shadow 0.23s, transform 0.05s;
}
button.primary {
  background: var(--main-red);
  color: var(--main-white);
  box-shadow: 0 6px 18px -8px rgba(0,0,0,0.45);
}
button.primary:hover {
  background: var(--main-darkred);
  box-shadow: 0 8px 22px -10px rgba(0,0,0,0.55);
  transform: translateY(-1px);
}
button.secondary {
  background: var(--main-white);
  color: var(--main-red);
  border: 2px solid var(--main-red);
}
button.secondary:hover {
  background: var(--main-pale);
  color: var(--main-darkred);
}
.entry, #tableContainer {
  margin-top: 22px;
  padding: 16px;
  border-radius: 10px;
  background: var(--main-pale);
  font-size: 1.02rem;
  color: var(--main-darkred);
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: var(--main-white);
}
th, td {
  border: 1px solid var(--main-red);
  padding: 8px 7px;
  text-align: left;
  font-size: 0.96rem;
}
th {
  background: var(--main-red);
  color: var(--main-white);
  font-family: "Montserrat", Arial, sans-serif;
  font-weight: 800;
  letter-spacing: 1.1px;
}
#copyButton {
  margin-top: 12px;
  float: right;
}
#toggleView {
  display: block;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 18px;
}
.desktop form {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px 28px;
}
.desktop form > div.full-width,
.desktop .full-width {
  grid-column: span 2;
}
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.35);
  z-index: 1000;
}
.modal-content {
  background: var(--main-white);
  margin: 10% auto;
  padding: 28px 24px 20px 24px;
  width: 96%;
  max-width: 340px;
  border: 2px solid var(--main-red);
  border-radius: 16px;
  color: var(--main-red);
  font-size: 1rem;
  position: relative;
}
.close {
  position: absolute;
  top: 8px; right: 14px;
  font-size: 26px;
  cursor: pointer;
  color: var(--main-darkred);
  font-weight: bold;
}
.close:hover { color: var(--main-red); }
@media (max-width: 700px) {
  .container {padding: 22px 10px 24px;}
  th, td {font-size: 0.9rem;}
  .modal-content {padding: 20px 7vw;}
}
</style>
</head>
<body>
<header>
  <img src="https://raw.githubusercontent.com/Vedharsh7373/JA/main/ja.png"
       alt="Johns Academy Logo"
       style="height:80px; margin-bottom:6px; margin-top:4px;">
  <h1>JOHNS ACADEMY TUITION LOG</h1>
</header>

<div class="container" id="mainContainer">
  <button id="toggleView" class="secondary">Optimize for Desktop</button>

  <form id="entryForm">
    <div>
      <label>Teacher:</label>
      <select id="teacher">
        <option value="" disabled selected>Will be auto-set</option>
      </select>
    </div>

    <div>
      <label>Student:</label>
      <select id="student" required>
        <option value="" disabled selected>Select Student</option>
      </select>
    </div>

    <div>
      <label>Subject:</label>
      <select id="subject" required>
        <option value="" disabled selected>Select Subject</option>
      </select>
    </div>

    <div>
      <label>Chapter:</label>
      <input type="text" id="chapter" required>
    </div>

    <div class="full-width">
      <label>Work Done:</label>
      <textarea id="workDone" rows="3" required></textarea>
    </div>

    <button type="submit" class="primary">Submit Entry</button>
  </form>

  <div style="margin-top:15px">
    <button id="addStudentBtn" class="secondary">Add Student</button>
    <button id="addTeacherBtn" class="secondary">Add Teacher</button>
  </div>

  <div style="margin-top:15px">
    <label>Enter PIN to view today's submissions:</label>
    <input type="password" id="pin" placeholder="Enter PIN">
    <button id="viewSubmissionsBtn" class="primary">View Submissions</button>
  </div>

  <div id="output" class="entry" style="display:none"></div>
  <div id="tableContainer"></div>
</div>

<div class="modal" id="studentModal">
  <div class="modal-content">
    <span class="close" id="closeStudentModal">&times;</span>
    <h3 style="margin-top:0;">Add New Student</h3>
    <label>Name:</label>
    <input type="text" id="newStudentName">
    <label>Assign Teacher:</label>
    <select id="newStudentTeacher"></select>
    <button id="saveStudentBtn" class="primary">Save Student</button>
  </div>
</div>

<div class="modal" id="teacherModal">
  <div class="modal-content">
    <span class="close" id="closeTeacherModal">&times;</span>
    <h3 style="margin-top:0;">Add New Teacher</h3>
    <label>Display Name:</label>
    <input type="text" id="newTeacherName">
    <label>Subjects (comma separated):</label>
    <input type="text" id="newTeacherSubjects">
    <label>PIN (numbers only):</label>
    <input type="password" id="newTeacherPin">
    <button id="saveTeacherBtn" class="primary">Save Teacher</button>
  </div>
</div>

<footer style="margin-top:24px; text-align:center; padding:14px 8px; font-family:'Montserrat',Arial,sans-serif; font-size:0.9rem; color:darkred;">
  <span style="margin-right:6px;">Made by</span>
  <a href="https://web-bros-fqzz.b12sites.com" target="_blank" rel="noopener noreferrer"
     style="color:red; font-weight:700; text-decoration:none;">
    Web Bros
  </a>
</footer>

<script>
const STORAGE_KEY = "teacherPortalData_v2";
const STORAGE_ACCEPT_KEY = "teacherPortalStorageAccepted";
const SELECTED_TEACHER_KEY = "teacherPortalSelectedTeacher";
const FOUR_MONTHS_MS = 1000 * 60 * 60 * 24 * 30 * 4;

const TEACHERS_SEED = {
  geethu: {
    display: "GEETHU M'am",
    pin: "2834",
    subjects: ["English", "SST", "Other"],
    students: [
      "ISHAN (ONLINE)",
      "JAI",
      "AZMINA",
      "ANIKET",
      "SADHYA",
      "DHRUV",
      "KEERTHAN",
      "KEERTHANA",
      "TANMAI VITUKURI",
      "PRASHAM",
      "SMRITHI",
      "VIDHI",
      "DAKSH",
      "AMY",
      "VEDHIKA",
      "VIVAN"
    ]
  },
  divya: {
    display: "DIVYA M'am",
    pin: "7358",
    subjects: ["Science", "Other"],
    students: [
      "MANASVI",
      "RISHAB",
      "RUHINAA",
      "DHRUV",
      "KEERTHAN",
      "AAYAN",
      "KEERTHANA",
      "SMRITHI",
      "AMY",
      "ANGATH",
      "NAVANEETH",
      "VEDANSH",
      "VEDHIKA",
      "VIDHI",
      "ADVAITH",
      "ADVIKA",
      "AKRITHI",
      "DANYA",
      "GURANSH SINGH",
      "MANYA",
      "VIVAN"
    ]
  },
  aishwarya: {
    display: "AISHWARYA M'am",
    pin: "9384",
    subjects: ["Math", "Other"],
    students: [
      "ADVAITH",
      "SHRAVYA",
      "MERRIN",
      "GURANSH SINGH",
      "AKRITHI",
      "ARYAN",
      "ARYA HEGDE",
      "ADVIKA",
      "MANYA",
      "NAVANEETH",
      "DAKSH",
      "VEDANSH",
      "VEDHARSH",
      "VIDHI",
      "AMY",
      "ANGATH",
      "DIVITH",
      "SWETHA PRASANNA",
      "VAIHNAV SARAVANAKUMAR",
      "SAHIL",
      "VEDHIKA",
      "ARIN",
      "AAYAN",
      "DHEER",
      "VEDANTH",
      "SADHYA",
      "SHRISHTI",
      "ABHISHEK (wkend)",
      "SRIYAM (wkend)",
      "KARAN (wkend)",
      "NITHYA (Singapore)",
      "VARDHINI",
      "ISHA",
      "PANAV SHARMA",
      "GEENA",
      "MANASVI",
      "ANWESHA",
      "RISHAB",
      "VISHNU TEJ (Wkend)",
      "RUHINAA"
    ]
  }
};

let teachers = {};
let entries = [];
let selectedTeacherId = null;

function ensureStoragePermission() {
  const accepted = localStorage.getItem(STORAGE_ACCEPT_KEY);
  if (!accepted) {
    const ok = confirm(
      "This app uses your browser's local storage to save teachers, students, and submissions for about 4 months. Click OK to allow."
    );
    if (!ok) {
      alert("Without storage permission, the portal cannot save your data.");
      return false;
    }
    localStorage.setItem(STORAGE_ACCEPT_KEY, "yes");
  }
  return true;
}

function loadFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      teachers = JSON.parse(JSON.stringify(TEACHERS_SEED));
      entries = [];
      saveToStorage();
      return;
    }
    const data = JSON.parse(raw);
    teachers = data.teachers || JSON.parse(JSON.stringify(TEACHERS_SEED));
    entries = (data.entries || []).filter(e => {
      const createdAt = e.createdAt || Date.now();
      return Date.now() - createdAt < FOUR_MONTHS_MS;
    });
    saveToStorage();
  } catch (e) {
    teachers = JSON.parse(JSON.stringify(TEACHERS_SEED));
    entries = [];
    saveToStorage();
  }
}

function saveToStorage() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ teachers, entries }));
}

function showTeacherSelectPrompt() {
  let message = "Select your teacher by typing the number:\n";
  const ids = Object.keys(teachers);
  ids.forEach((id, index) => {
    message += `${index + 1}. ${teachers[id].display}\n`;
  });
  const input = prompt(message);
  if (!input) return null;
  const idx = parseInt(input, 10) - 1;
  if (isNaN(idx) || idx < 0 || idx >= ids.length) {
    alert("Invalid choice. Please reload and try again.");
    return null;
  }
  return ids[idx];
}

function ensureSelectedTeacher() {
  let t = localStorage.getItem(SELECTED_TEACHER_KEY);
  if (t && teachers[t]) {
    selectedTeacherId = t;
    return true;
  }
  const chosen = showTeacherSelectPrompt();
  if (!chosen) return false;
  selectedTeacherId = chosen;
  localStorage.setItem(SELECTED_TEACHER_KEY, chosen);
  return true;
}

window.addEventListener("load", function () {
  if (!ensureStoragePermission()) return;
  loadFromStorage();
  if (!ensureSelectedTeacher()) return;
  setupFormForSelectedTeacher();
  buildCalendarInterface();
});

function setupFormForSelectedTeacher() {
  const teacher = teachers[selectedTeacherId];
  const teacherSelect = document.getElementById("teacher");
  if (teacherSelect && teacherSelect.parentElement) {
    teacherSelect.parentElement.style.display = "none";
  }
  const studentSelect = document.getElementById("student");
  const subjectSelect = document.getElementById("subject");
  if (!studentSelect || !subjectSelect) return;

  studentSelect.innerHTML = '<option value="" disabled selected>Select Student</option>';
  (teacher.students || []).forEach(s => {
    let o = document.createElement("option");
    o.value = s;
    o.textContent = s;
    studentSelect.appendChild(o);
  });

  subjectSelect.innerHTML = '<option value="" disabled selected>Select Subject</option>';
  (teacher.subjects || []).forEach(s => {
    let o = document.createElement("option");
    o.value = s;
    o.textContent = s;
    subjectSelect.appendChild(o);
  });
}

document.getElementById("entryForm").addEventListener("submit", function (e) {
  e.preventDefault();
  if (!ensureStoragePermission()) return;
  if (!selectedTeacherId) {
    alert("No teacher selected.");
    return;
  }

  const student = document.getElementById("student").value;
  const subject = document.getElementById("subject").value;
  const chapter = document.getElementById("chapter").value;
  const workDone = document.getElementById("workDone").value;

  if (!student || !subject || !chapter || !workDone) {
    alert("Please fill all fields.");
    return;
  }

  const today = new Date().toISOString().split("T")[0];
  const entry = {
    date: today,
    teacherId: selectedTeacherId,
    student,
    subject,
    chapter,
    workDone,
    createdAt: Date.now()
  };

  entries.push(entry);
  saveToStorage();
  showSubmission(student, subject, chapter, workDone);
  refreshCalendarView();
});

function showSubmission(student, subject, chapter, workDone) {
  const output = document.getElementById("output");
  const teacher = teachers[selectedTeacherId];
  output.innerHTML = `<b>Submission Successful!</b><br><br>
Teacher: ${teacher.display}<br>
Student: ${student}<br>
Subject: ${subject}<br>
Chapter: ${chapter}<br>
Work Done: ${workDone}`;
  output.style.display = "block";
  document.getElementById("entryForm").reset();
  setTimeout(() => output.style.display = "none", 5000);
}

document.getElementById("addStudentBtn").onclick = function() {
  let select = document.getElementById("newStudentTeacher");
  select.innerHTML = "";
  Object.keys(teachers).forEach(k => {
    let o = document.createElement("option");
    o.value = k;
    o.textContent = teachers[k].display;
    select.appendChild(o);
  });
  document.getElementById("studentModal").style.display = "block";
};

document.getElementById("closeStudentModal").onclick = function() {
  document.getElementById("studentModal").style.display = "none";
};

document.getElementById("saveStudentBtn").onclick = function() {
  let name = document.getElementById("newStudentName").value.trim();
  let tch = document.getElementById("newStudentTeacher").value;
  if (!name || !tch) return alert("Enter student name and teacher.");
  if (!teachers[tch].students) teachers[tch].students = [];
  teachers[tch].students.push(name);
  saveToStorage();
  if (tch === selectedTeacherId) setupFormForSelectedTeacher();
  document.getElementById("studentModal").style.display = "none";
  document.getElementById("newStudentName").value="";
  alert("Student added!");
};

document.getElementById("addTeacherBtn").onclick = function() {
  document.getElementById("teacherModal").style.display = "block";
};

document.getElementById("closeTeacherModal").onclick = function() {
  document.getElementById("teacherModal").style.display = "none";
};

document.getElementById("saveTeacherBtn").onclick = function() {
  let display = document.getElementById("newTeacherName").value.trim();
  let subjects = document.getElementById("newTeacherSubjects").value
    .split(",").map(s => s.trim()).filter(Boolean);
  let pin = document.getElementById("newTeacherPin").value.trim();
  if (!display || !subjects.length || !pin) return alert("Fill all fields.");
  const id = "t_" + Date.now() + "_" + Math.floor(Math.random()*1000);
  teachers[id] = { display, subjects, pin, students: [] };
  saveToStorage();
  document.getElementById("teacherModal").style.display = "none";
  document.getElementById("newTeacherName").value = "";
  document.getElementById("newTeacherSubjects").value = "";
  document.getElementById("newTeacherPin").value = "";
  alert("Teacher added!");
};

window.onclick = function(ev) {
  if (ev.target === document.getElementById("studentModal"))
    document.getElementById("studentModal").style.display = "none";
  if (ev.target === document.getElementById("teacherModal"))
    document.getElementById("teacherModal").style.display = "none";
};

document.getElementById("viewSubmissionsBtn").onclick = function() {
  const pin = document.getElementById("pin").value;
  const teacherKey = Object.keys(teachers).find(k => teachers[k].pin === pin);
  if (!teacherKey) { alert("Invalid PIN"); return; }
  const today = new Date().toISOString().split("T")[0];
  const todaysEntries = entries.filter(e => e.teacherId === teacherKey && e.date === today);
  if (todaysEntries.length > 0) displayTable(todaysEntries);
  else document.getElementById("tableContainer").innerHTML = "No submissions for today.";
};

function displayTable(list) {
  let html = `<table id='submissionsTable'><tr>
<th>Date</th><th>Student</th><th>Subject</th><th>Chapter</th><th>Work Done</th></tr>`;
  list.forEach(r => {
    html += `<tr>
<td>${r.date}</td>
<td>${r.student}</td>
<td>${r.subject}</td>
<td>${r.chapter}</td>
<td>${r.workDone}</td>
</tr>`;
  });
  html += `</table><button id='copyButton' class='secondary'>Copy Table</button>`;
  document.getElementById("tableContainer").innerHTML = html;
  document.getElementById('copyButton').onclick = function() {
    let table = document.getElementById('submissionsTable');
    let range = document.createRange();
    range.selectNode(table);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    try {
      document.execCommand("copy");
      alert("Table copied to clipboard!");
    } catch (e) {
      alert("Copy failed. Please copy manually.");
    }
    window.getSelection().removeAllRanges();
  };
}

function buildCalendarInterface() {
  const container = document.getElementById("tableContainer");
  container.innerHTML = `
    <div id="calendarView">
      <h3 style="margin-top:10px;">Entries Calendar</h3>
      <div id="monthList" style="margin-bottom:8px;"></div>
      <div id="dayList" style="margin-bottom:8px;"></div>
      <div id="dayEntries"></div>
    </div>
  `;
  refreshCalendarView();
}

function refreshCalendarView() {
  if (!selectedTeacherId) return;
  const filtered = entries.filter(e => e.teacherId === selectedTeacherId);
  const monthsDiv = document.getElementById("monthList");
  const daysDiv = document.getElementById("dayList");
  const dayEntriesDiv = document.getElementById("dayEntries");
  if (!monthsDiv || !daysDiv || !dayEntriesDiv) return;

  const monthMap = {};
  filtered.forEach(e => {
    const d = new Date(e.date);
    const key = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
    if (!monthMap[key]) monthMap[key] = [];
    monthMap[key].push(e);
  });

  const monthKeys = Object.keys(monthMap).sort();
  if (monthKeys.length === 0) {
    monthsDiv.innerHTML = "No entries yet.";
    daysDiv.innerHTML = "";
    dayEntriesDiv.innerHTML = "";
    return;
  }

  monthsDiv.innerHTML = "Months: ";
  monthKeys.forEach((mk, idx) => {
    const dParts = mk.split("-");
    const year = dParts[0];
    const monthIndex = parseInt(dParts[1], 10) - 1;
    const monthName = new Date(year, monthIndex, 1).toLocaleString("en-US", {month:"short"});
    const btn = document.createElement("button");
    btn.textContent = monthName + " " + year;
    btn.className = "secondary";
    btn.style.marginRight = "6px";
    btn.onclick = function() { renderDaysForMonth(mk, monthMap[mk]); };
    monthsDiv.appendChild(btn);
    if (idx === monthKeys.length - 1) renderDaysForMonth(mk, monthMap[mk]);
  });
}

function renderDaysForMonth(monthKey, list) {
  const daysDiv = document.getElementById("dayList");
  const dayEntriesDiv = document.getElementById("dayEntries");
  daysDiv.innerHTML = "Days: ";
  dayEntriesDiv.innerHTML = "";

  const dayMap = {};
  list.forEach(e => {
    if (!dayMap[e.date]) dayMap[e.date] = [];
    dayMap[e.date].push(e);
  });
  const dayKeys = Object.keys(dayMap).sort();
  dayKeys.forEach((dk, idx) => {
    const d = new Date(dk);
    const label = d.getDate();
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.className = "secondary";
    btn.style.marginRight = "4px";
    btn.onclick = function() { renderEntriesForDay(dk, dayMap[dk]); };
    daysDiv.appendChild(btn);
    if (idx === dayKeys.length - 1) renderEntriesForDay(dk, dayMap[dk]);
  });
}

function renderEntriesForDay(dateStr, list) {
  const dayEntriesDiv = document.getElementById("dayEntries");
  if (!list || list.length === 0) {
    dayEntriesDiv.innerHTML = "No entries.";
    return;
  }
  let html = `<h4>Entries for ${dateStr}</h4><table><tr>
<th>Student</th><th>Subject</th><th>Chapter</th><th>Work Done</th></tr>`;
  list.forEach(r => {
    html += `<tr>
<td>${r.student}</td>
<td>${r.subject}</td>
<td>${r.chapter}</td>
<td>${r.workDone}</td>
</tr>`;
  });
  html += `</table>`;
  dayEntriesDiv.innerHTML = html;
}

document.getElementById("toggleView").addEventListener("click", function () {
  const main = document.getElementById("mainContainer");
  main.classList.toggle("desktop");
  document.getElementById("toggleView").textContent = main.classList.contains("desktop")
    ? "Optimize for Mobile"
    : "Optimize for Desktop";
});
</script>
</body>
</html>
